name: Test Interactive Install

on:
  push:
    branches: [ sys-513 ]
  pull_request:
    branches: [ sys-513 ]

jobs:
  install_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      # 3. Install Core Prerequisites
      - name: Install Core Prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y expect curl git openssl
        shell: bash

      # 4. Install Docker Compose
      - name: Install Docker Compose
        run: |
          # Download Docker Compose binary
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          
          # Apply executable permissions to the binary
          sudo chmod +x /usr/local/bin/docker-compose
          
          # Verify installation
          /usr/local/bin/docker-compose --version
        shell: bash

      # 5. Add /usr/local/bin to PATH
      - name: Add /usr/local/bin to PATH
        run: echo "/usr/local/bin" >> $GITHUB_PATH
        shell: bash

      # 6. Verify Installations
      - name: Verify Installations
        run: |
          git --version
          docker --version
          docker-compose --version
          openssl version
          expect --version
          curl --version
        shell: bash

      # 7. Make installer.sh Executable
      - name: Make installer.sh executable
        run: chmod +x ./installer.sh

      # 8. Run installer.sh with Expect to Handle Interactive Prompts
      - name: Run installer.sh with expect
        run: |
          expect << 'EOF'
          set timeout -1
          spawn ./installer.sh

          expect {
            "Would you like to install openssl? (y/n) " {
              send "y\r"
              exp_continue
            }
            "By running this installer, you agree to allow the Shardeum team to collect this data. (Y/n)?" {
              send "y\r"
              exp_continue
            }
            "What base directory should the node use (default ~/.shardeum): " {
              send "\r"
              exp_continue
            }
            "Do you want to run the web based Dashboard? (Y/n): " {
              send "y\r"
              exp_continue
            }
            "Do you want to change the password for the Dashboard? (y/N): " {
              send "n\r"
              exp_continue
            }
            "Enter the port (1025-65536) to access the web based Dashboard (default 8080): " {
              send "\r"
              exp_continue
            }
            "If you wish to set an explicit external IP, enter an IPv4 address (default=auto): " {
              send "auto\r"
              exp_continue
            }
            "If you wish to set an explicit internal IP, enter an IPv4 address (default=auto): " {
              send "auto\r"
              exp_continue
            }
            "Enter the first port (1025-65536) for p2p communication (default 9001): " {
              send "\r"
              exp_continue
            }
            "Enter the second port (1025-65536) for p2p communication (default 10001): " {
              send "\r"
              exp_continue
            }
            eof
          }
          EOF
        shell: bash

      # 9. Wait for the Service to Initialize
      - name: Wait for service to start
        run: |
          echo "Waiting for service to start..."
          sleep 30  # Adjust this duration if necessary
        shell: bash

      # 10. Verify that the Service is Up by Curling localhost:8080
      - name: Check service is up
        run: |
          echo "Verifying that the service is up..."
          curl -f http://localhost:8080
        shell: bash
